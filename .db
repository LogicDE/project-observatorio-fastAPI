-- Creacion de base de datos con POSTGRESQL

CREATE DATABASE project_observatory;

-- Tabla categories

CREATE TABLE categories (
    id_category SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL
);


-- Tabla featured_data 

CREATE TABLE featured_data (
    id_featured SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    date DATE NOT NULL,
    data NUMERIC NOT NULL,
    is_main BOOLEAN DEFAULT FALSE,
    category_id INT REFERENCES categories(id_category) ON DELETE SET NULL
);


-- is_main: atributo booleano para listarlo en el dashboard (sin categoria asociada)


-- Tabla categories con soporte para subcategorías

CREATE TABLE categories (
    id_category SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    parent_id INT REFERENCES categories(id_category) ON DELETE CASCADE
);


-- Modificacion para hacer la tabla recursiva:
-- Agregar la columna parent_id
ALTER TABLE categories
ADD COLUMN parent_id INT;
-- Crear la clave foránea
ALTER TABLE categories
ADD CONSTRAINT fk_parent_category
FOREIGN KEY (parent_id)
REFERENCES categories(id_category)
ON DELETE CASCADE;


-- Crear Tabla chart_data para los gráficos
CREATE TABLE chart_data (
    id_chart SERIAL PRIMARY KEY,
    year INT NOT NULL,
    week INT,  -- Este campo será NULL para datos anuales
    value NUMERIC NOT NULL,
    category_id INT REFERENCES categories(id_category) ON DELETE CASCADE
);

-- Identificador unico del nombre del gráfico
ALTER TABLE chart_data
ADD COLUMN chart_name VARCHAR(255) NOT NULL;

-- Identificador para tipo de tabla (anual o semanal)
ALTER TABLE chart_data
ADD COLUMN chart_type VARCHAR(20) CHECK (chart_type IN ('annual', 'weekly')) NOT NULL;

-- Eliminar las columnas 'year' y 'week'
ALTER TABLE chart_data
DROP COLUMN year,
DROP COLUMN week;

-- Agregar la nueva columna 'date'
ALTER TABLE chart_data
ADD COLUMN date VARCHAR(20) NOT NULL;
